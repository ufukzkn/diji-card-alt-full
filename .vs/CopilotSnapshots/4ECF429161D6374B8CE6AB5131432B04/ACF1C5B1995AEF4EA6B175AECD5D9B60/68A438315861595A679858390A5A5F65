// src/app/components/profile/profile.ts

import { Component, OnInit }           from '@angular/core';
import { CommonModule }                 from '@angular/common';
import { RouterModule, ActivatedRoute } from '@angular/router';
import { QRCodeModule } from 'angularx-qrcode';

import { ProfileService }               from '../../services/profile';
import { UsersService }                 from '../../services/users';

import { LinkEditor }                   from '../link-editor/link-editor';

import { UserProfile }                  from '../../models/user-profile.model';
import { User }                         from '../../models/user.models';

@Component({
  selector: 'app-profile',
  standalone: true,
  imports: [
    CommonModule,
    RouterModule,
    LinkEditor,
    QRCodeModule
  ],
  templateUrl: './profile.html',
  styleUrls: ['./profile.scss']
})
export class Profile implements OnInit {
  userId!: string;
  user?: User;
  profile?: UserProfile;
  get profileUrl() {
    return window.location.origin + '/profile/' + this.userId;
  }

  constructor(
    private route: ActivatedRoute,
    private profSvc: ProfileService,
    private userSvc: UsersService
  ) {}

  ngOnInit(): void {
    this.route.paramMap.subscribe(params => {
      const id = params.get('userId');
      if (!id) return;
      this.userId = id;
      this.loadData();
    });
  }

  private loadData(): void {
    // Default user info from Users table
    this.userSvc.getById(this.userId).subscribe(u => (this.user = u));

    // Dynamic links from UserDefinitionValues
    this.profSvc.get(this.userId).subscribe(p => (this.profile = p));
  }

  get sortedLinks() {
    return (this.profile?.links ?? []).slice().sort((a, b) =>
      a.definitionName.localeCompare(b.definitionName)
    );
  }
}
